<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <title>내 주변 카페</title>
    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=qb8k02fqhx"></script>
</head>

    <div layout:fragment="content">
        본문 영역 입니다.

        <div id="map" style="width:100%;height:400px;"></div>


        <script>

            // Example POST method implementation:
            async function postData(url = "", data = {}) {
                // Default options are marked with *
                const response = await fetch(url, {
                    method: "POST", // *GET, POST, PUT, DELETE, etc.
                    mode: "cors", // no-cors, *cors, same-origin
                    cache: "no-cache", // *default, no-cache, reload, force-cache, only-if-cached
                    credentials: "same-origin", // include, *same-origin, omit
                    headers: {
                        "Content-Type": "application/json",
                        // 'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    redirect: "follow", // manual, *follow, error
                    referrerPolicy: "no-referrer", // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
                    body: JSON.stringify(data), // body data type must match "Content-Type" header
                });
                return response.json(); // parses JSON response into native JavaScript objects
            }



            const options = {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0,
            };

            // 현재위치 찾기
            navigator.geolocation.getCurrentPosition(success, error, options);

            // 위치 찾기 성공시
            function success(pos) {
                const crd = pos.coords;

                console.log("Your current position is:");
                console.log(`Latitude : ${crd.latitude}`);
                console.log(`Longitude: ${crd.longitude}`);
                console.log(`More or less ${crd.accuracy} meters.`);

                var mapOptions = {
                    center: new naver.maps.LatLng(crd.latitude, crd.longitude),
                    zoom: 17
                };

                var map = new naver.maps.Map('map', mapOptions);

                // var marker = new naver.maps.Marker({
                //     position: new naver.maps.LatLng(crd.latitude, crd.longitude),
                //     map: map
                // })

                // 드래그 끝나면
                naver.maps.Event.addListener(map, 'dragend', function(e) {
                    console.log(e.coord._lng+' '+e.coord._lat);

                    // fetch 비동기 통신
                    postData("http://localhost/", { lng : e.coord._lng, lat : e.coord._lat }).then((data) => {
                        console.log(data); // JSON data parsed by `data.json()` call


                        var HOME_PATH = 'https://navermaps.github.io/maps.js/docs/';
                        var MARKER_SPRITE_X_OFFSET = 29,
                            MARKER_SPRITE_Y_OFFSET = 50,
                            MARKER_SPRITE_POSITION = {
                                "A0": [0, 0],
                                "B0": [MARKER_SPRITE_X_OFFSET, 0],
                                "C0": [MARKER_SPRITE_X_OFFSET*2, 0],
                                "D0": [MARKER_SPRITE_X_OFFSET*3, 0],
                                "E0": [MARKER_SPRITE_X_OFFSET*4, 0],
                                "F0": [MARKER_SPRITE_X_OFFSET*5, 0],
                                "G0": [MARKER_SPRITE_X_OFFSET*6, 0],
                                "H0": [MARKER_SPRITE_X_OFFSET*7, 0],
                                "I0": [MARKER_SPRITE_X_OFFSET*8, 0],

                                "A1": [0, MARKER_SPRITE_Y_OFFSET],
                                "B1": [MARKER_SPRITE_X_OFFSET, MARKER_SPRITE_Y_OFFSET],
                                "C1": [MARKER_SPRITE_X_OFFSET*2, MARKER_SPRITE_Y_OFFSET],
                                "D1": [MARKER_SPRITE_X_OFFSET*3, MARKER_SPRITE_Y_OFFSET],
                                "E1": [MARKER_SPRITE_X_OFFSET*4, MARKER_SPRITE_Y_OFFSET],
                                "F1": [MARKER_SPRITE_X_OFFSET*5, MARKER_SPRITE_Y_OFFSET],
                                "G1": [MARKER_SPRITE_X_OFFSET*6, MARKER_SPRITE_Y_OFFSET],
                                "H1": [MARKER_SPRITE_X_OFFSET*7, MARKER_SPRITE_Y_OFFSET],
                                "I1": [MARKER_SPRITE_X_OFFSET*8, MARKER_SPRITE_Y_OFFSET],

                                "A2": [0, MARKER_SPRITE_Y_OFFSET*2],
                                "B2": [MARKER_SPRITE_X_OFFSET, MARKER_SPRITE_Y_OFFSET*2],
                                "C2": [MARKER_SPRITE_X_OFFSET*2, MARKER_SPRITE_Y_OFFSET*2],
                                "D2": [MARKER_SPRITE_X_OFFSET*3, MARKER_SPRITE_Y_OFFSET*2],
                                "E2": [MARKER_SPRITE_X_OFFSET*4, MARKER_SPRITE_Y_OFFSET*2],
                                "F2": [MARKER_SPRITE_X_OFFSET*5, MARKER_SPRITE_Y_OFFSET*2],
                                "G2": [MARKER_SPRITE_X_OFFSET*6, MARKER_SPRITE_Y_OFFSET*2],
                                "H2": [MARKER_SPRITE_X_OFFSET*7, MARKER_SPRITE_Y_OFFSET*2],
                                "I2": [MARKER_SPRITE_X_OFFSET*8, MARKER_SPRITE_Y_OFFSET*2]
                            };


                        var markers = [], infoWindows = [];

                        for (var key in data) {
                            console.log(data[key].lat);
                            var position = new naver.maps.LatLng(
                                data[key].lat, data[key].lng
                                // southWest.lat() + latSpan * Math.random(),
                                // southWest.lng() + lngSpan * Math.random()
                            );

                            var marker = new naver.maps.Marker({
                                map: map,
                                position: position,
                                title: key,
                                icon: {
                                    url: HOME_PATH +'/img/example/sp_pins_spot_v3.png',
                                    size: new naver.maps.Size(24, 37),
                                    anchor: new naver.maps.Point(12, 37),
                                    origin: new naver.maps.Point(MARKER_SPRITE_POSITION[key][0], MARKER_SPRITE_POSITION[key][1])
                                },
                                zIndex: 100
                            });

                            // var infoWindow = new naver.maps.InfoWindow({
                            //     content: '<div style="width:150px;text-align:center;padding:10px;">The Letter is <b>"'+ key.substr(0, 1) +'"</b>.</div>'
                            // });

                            markers.push(marker);
                            // infoWindows.push(infoWindow);
                        };

                        // naver.maps.Event.addListener(map, 'idle', function() {
                            updateMarkers(map, markers);
                        // });

                        function updateMarkers(map, markers) {

                            // var mapBounds = map.getBounds();
                            var marker, position;

                            for (var i = 0; i < markers.length; i++) {

                                marker = markers[i]
                                position = marker.getPosition();

                                // if (mapBounds.hasLatLng(position)) {
                                    showMarker(map, marker);
                                // } else {
                                //     hideMarker(map, marker);
                                // }
                            }
                        }

                        function showMarker(map, marker) {

                            if (marker.setMap()) return;
                            marker.setMap(map);
                        }

                        // function hideMarker(map, marker) {
                        //
                        //     if (!marker.setMap()) return;
                        //     marker.setMap(null);
                        // }

                        // Return an event handler storing the marker index as a closure variable named seq.
                        // function getClickHandler(seq) {
                        //     return function(e) {
                        //         var marker = markers[seq],
                        //             infoWindow = infoWindows[seq];
                        //
                        //         if (infoWindow.getMap()) {
                        //             infoWindow.close();
                        //         } else {
                        //             infoWindow.open(map, marker);
                        //         }
                        //     }
                        // }

                        // for (var i=0, ii=markers.length; i<ii; i++) {
                        //     naver.maps.Event.addListener(markers[i], 'click', getClickHandler(i));
                        // }



                    });
                });
            }

            function error(err) {
                console.warn(`ERROR(${err.code}): ${err.message}`);


            }





        </script>
    </div>

</html>