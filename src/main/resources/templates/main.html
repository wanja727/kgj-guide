<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <title>ë‚´ ì£¼ë³€ ì¹´í˜</title>
    <style>
        ::-webkit-scrollbar {
            width: 12px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #969faf;
            border: 3px solid #f5f6f7;
            border-radius: 20px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        .list-group-item.active{
            color: #212529;
            background-color: #e9ecef;
            border-color: #e9ecef;
        }
        label.btn.btn-outline-success{
            display: flex;
            width: 250px;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.4.js"></script>
    <script type="text/javascript"
            src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=qb8k02fqhx"></script>
    <script type="text/javascript" th:src="@{/js/MarkerOverlappingRecognizer.js}"></script>
</head>

<div layout:fragment="content">

    <div class="float-start overflow-auto" style="width: 315px;height: calc(100vh - 56px)">
        <ul class="list-group" id="cafeList">
        </ul>
    </div>

    <!--ì¹´í˜ ì •ë³´-->
    <div class="overflow-auto" id="overlay1"
         style="position: fixed;display: none;width: 325px;height: calc(100vh - 56px);top: 56px;left: 315px;right: 0;bottom: 0;background-color: rgba(255,255,255,1);z-index: 2;">

        <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
            <ol class="breadcrumb mt-3 mx-3">
                <li class="breadcrumb-item active fw-bold" aria-current="page">â˜•ï¸ì¹´í˜ ì •ë³´</li>
            </ol>
        </nav>

        <div id="cafeInfo" class="card border-success m-1" style="width:auto;">
        </div>

        <div id="reviewHeader" class="d-flex justify-content-between m-1" style="align-items: center"></div>

        <ul class="list-group" id="reviewList"></ul>
    </div>

    <!--ë‹«ê¸° ë²„íŠ¼-->
    <button type="button" class="btn-close" aria-label="Close" onclick="closeAll()" id="overlay2"
            style="position: fixed;display: none;width: 50px;height: 50px;top: 56px;left: 640px;right: 0;bottom: 0;background-color: rgba(255,255,255,1);z-index: 2;cursor: pointer;"></button>

    <!--ë¦¬ë·° ì“°ê¸°-->
    <div class="overflow-auto" id="overlay3"
         style="position: fixed;display: none;width: 325px;height: calc(100vh - 56px);top: 56px;left: 315px;right: 0;bottom: 0;background-color: rgba(255,255,255,1);z-index: 2;">

        <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
            <ol class="breadcrumb mt-3 mx-3">
                <li class="breadcrumb-item"><a class="text-decoration-none fw-bold" href="javascript:closeReview()">â˜•ï¸ì¹´í˜ ì •ë³´</a></li>
                <li class="breadcrumb-item active fw-bold" aria-current="page">âœï¸ë¦¬ë·° ì“°ê¸°</li>
            </ol>
        </nav>

        <div class="p-2 pb-5 mb-5">
            <div class="fw-bold">ğŸ¢ë§¤ì¥í¬ê¸°(í…Œì´ë¸” ê°œìˆ˜)</div>

            <input type="radio" class="btn-check" name="options-size" id="size1" autocomplete="off" value="TAKEOUT">
            <label class="btn btn-outline-success mt-1" for="size1">ğŸí…Œì´í¬ì•„ì›ƒ ì „ìš©</label>

            <input type="radio" class="btn-check" name="options-size" id="size2" autocomplete="off" value="SMALL">
            <label class="btn btn-outline-success mt-1" for="size2">ğŸ ì†Œí˜•(1~8)</label>

            <input type="radio" class="btn-check" name="options-size" id="size3" autocomplete="off" value="MEDIUM">
            <label class="btn btn-outline-success mt-1" for="size3">ğŸ˜ì¤‘í˜•(9~16)</label>

            <input type="radio" class="btn-check" name="options-size" id="size4" autocomplete="off" value="LARGE">
            <label class="btn btn-outline-success mt-1" for="size4">ğŸ°ëŒ€í˜•</label>

            <div class="fw-bold mt-2">ğŸ”ë§¤ì¥ì¸µìˆ˜(ë³µì¸µì—¬ë¶€)</div>
            <input type="radio" class="btn-check" name="options-floor" id="floor1" autocomplete="off" value="FIRST">
            <label class="btn btn-outline-success mt-1" for="floor1">ğŸš¶â€1ì¸µï¸</label>

            <input type="radio" class="btn-check" name="options-floor" id="floor2" autocomplete="off" value="SECOND">
            <label class="btn btn-outline-success mt-1" for="floor2">ğŸª‚2ì¸µ</label>

            <input type="radio" class="btn-check" name="options-floor" id="floor3" autocomplete="off" value="THIRD">
            <label class="btn btn-outline-success mt-1" for="floor3">âœˆ3ì¸µ</label>

            <input type="radio" class="btn-check" name="options-floor" id="floor4" autocomplete="off" value="MORE">
            <label class="btn btn-outline-success mt-1" for="floor4">ğŸ›°ê·¸ ì´ìƒ</label>

            <div class="fw-bold mt-2">ğŸ”Œì½˜ì„¼íŠ¸(ê°œìˆ˜)</div>
            <input type="radio" class="btn-check" name="options-consent" id="consent1" autocomplete="off" value="1">
            <label class="btn btn-outline-success mt-1" for="consent1">ğŸš«ì½˜ì„¼íŠ¸ê°€ ì—†ì–´ìš”</label><!--ğŸŒ«-->

            <input type="radio" class="btn-check" name="options-consent" id="consent2" autocomplete="off" value="2">
            <label class="btn btn-outline-success mt-1" for="consent2">â˜ì ì€ í¸ì´ì—ìš”(1~5)</label>

            <input type="radio" class="btn-check" name="options-consent" id="consent3" autocomplete="off" value="3">
            <label class="btn btn-outline-success mt-1" for="consent3">ğŸŒ©ì ë‹¹íˆ ë§ì•„ìš”(6~10)</label>

            <input type="radio" class="btn-check" name="options-consent" id="consent4" autocomplete="off" value="4">
            <label class="btn btn-outline-success mt-1" for="consent4">âš¡ì•„ì£¼ ë§ì•„ìš”!</label>

            <div class="fw-bold mt-2">ğŸ“¡ì™€ì´íŒŒì´</div>
            <input type="radio" class="btn-check" name="options-wifi" id="wifi1" autocomplete="off" value="1">
            <label class="btn btn-outline-success mt-1" for="wifi1">ğŸš«ì™€ì´íŒŒì´ê°€ ì—†ì–´ìš”</label>

            <input type="radio" class="btn-check" name="options-wifi" id="wifi2" autocomplete="off" value="2">
            <label class="btn btn-outline-success mt-1" for="wifi2">ğŸ›´ëŠê¸°ê±°ë‚˜ ëŠë ¤ìš”</label><!--ğŸ›µ-->

            <input type="radio" class="btn-check" name="options-wifi" id="wifi3" autocomplete="off" value="3">
            <label class="btn btn-outline-success mt-1" for="wifi3">ğŸš—ì›í™œí•´ìš”</label>

            <input type="radio" class="btn-check" name="options-wifi" id="wifi4" autocomplete="off" value="4">
            <label class="btn btn-outline-success mt-1" for="wifi4">ğŸš€ì¾Œì í•´ìš”!</label>

            <div class="fw-bold mt-2">ğŸª‘ì¢Œì„ê³¼ í…Œì´ë¸”ì˜ í¸ì•ˆí•¨</div>
            <input type="radio" class="btn-check" name="options-comfort" id="comfort1" autocomplete="off" value="1">
            <label class="btn btn-outline-success mt-1" for="comfort1">ğŸ§—ë¶ˆí¸í•´ìš”</label>

            <input type="radio" class="btn-check" name="options-comfort" id="comfort2" autocomplete="off" value="2">
            <label class="btn btn-outline-success mt-1" for="comfort2">ğŸ¤¸í¸í•˜ì§„ ì•Šì€ë° ì•‰ì„ë§Œí•´ìš”</label>

            <input type="radio" class="btn-check" name="options-comfort" id="comfort3" autocomplete="off" value="3">
            <label class="btn btn-outline-success mt-1" for="comfort3">ğŸ§˜í¸ì•ˆí•´ìš”</label>

            <input type="radio" class="btn-check" name="options-comfort" id="comfort4" autocomplete="off" value="4">
            <label class="btn btn-outline-success mt-1" for="comfort4">ğŸ›Œì•ˆë½í•´ìš”!</label>

            <div class="form-floating mt-2">
            <textarea class="form-control" placeholder="Leave a comment here" id="floatingTextarea"
                      style="height: 200px"></textarea>
                <label for="floatingTextarea">í‰ê°€ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”! (í•„ìˆ˜ ì•„ë‹˜)</label>
            </div>

            <button type="button" class="btn btn-outline-success mt-2 float-end" onclick="register()">ë“± ë¡</button>
        </div>

    </div>

    <div id="map" class="" style="width: calc(100% - 315px);height: calc(100vh - 56px);"></div>

    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
<!--                <div class="modal-header">-->
<!--                    <h1 class="modal-title fs-5" id="exampleModalLabel">Modal title</h1>-->
<!--                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>-->
<!--                </div>-->
                <div class="modal-body">
                    í•´ë‹¹ ê¸°ëŠ¥ì€ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
<!--                    <button type="button" class="btn btn-primary">ë¡œê·¸ì¸ í•˜ê¸°</button>-->
                    <a href="/oauth2/authorization/google" class="btn btn-success active" role="button">ë¡œê·¸ì¸ í•˜ê¸°</a>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">

        // fetch ë¹„ë™ê¸°í˜¸ì¶œ
        async function postData(url = "", data = {}) {
            // Default options are marked with *
            const response = await fetch(url, {
                method: "POST", // *GET, POST, PUT, DELETE, etc.
                mode: "cors", // no-cors, *cors, same-origin
                cache: "no-cache", // *default, no-cache, reload, force-cache, only-if-cached
                credentials: "same-origin", // include, *same-origin, omit
                headers: {
                    "Content-Type": "application/json",
                    // 'Content-Type': 'application/x-www-form-urlencoded',
                },
                redirect: "follow", // manual, *follow, error
                referrerPolicy: "no-referrer", // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
                body: JSON.stringify(data), // body data type must match "Content-Type" header
            });
            return response.json(); // parses JSON response into native JavaScript objects
        }

        // NAVER Maps
        var map = new naver.maps.Map('map');
        var markers = [], infoWindows = [];
        var circle;

        var recognizer = new MarkerOverlappingRecognizer({
            highlightRect: false,
            tolerance: 5
        });

        recognizer.setMap(map);

        // ë§ˆì»¤ ë§ˆìš°ìŠ¤ì˜¤ë²„ì‹œì— ëª¨ì–‘ ë³€ê²½ (í˜„ì¬ ë¯¸ì‚¬ìš©)
        function highlightMarker(marker) {
            // var icon = marker.getIcon();
            //
            // if(!icon.highlight){
            //     let replaced_content = icon.content.replace('class="pins_s_tooltip"','class="pins_s_tooltip bg-success"');
            //     icon.content = replaced_content;
            //     icon.highlight = true;
            //     marker.setIcon(icon);
            // }
            marker.setZIndex(1000);
        }

        function unhighlightMarker(marker) {
            // var icon = marker.getIcon();
            //
            // if(icon.highlight){
            //     let replaced_content = icon.content.replace('class="pins_s_tooltip bg-success"','class="pins_s_tooltip"');
            //     icon.content = replaced_content;
            //     icon.highlight = false;
            //     marker.setIcon(icon);
            // }
            marker.setZIndex(100);
        }

        // í•´ë‹¹ ë§ˆì»¤ì˜ ì¸ë±ìŠ¤ë¥¼ seqë¼ëŠ” í´ë¡œì € ë³€ìˆ˜ë¡œ ì €ì¥í•˜ëŠ” ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
        function getClickHandler(cafeId, lat, lng) {
            return function(e) {
                map.panTo(new naver.maps.LatLng(lat, lng));
                cafeInfo(cafeId);
            }
        }

        function dragend(){
            var center = map.getCenter();
            console.log('center: ' + center._lng + ' ' + center._lat);

            // fetch ë¹„ë™ê¸° í†µì‹ 
            postData("http://localhost/", {lng: center._lng, lat: center._lat}).then((data) => {
                console.log(data); // JSON data parsed by `data.json()` call

                // ì´ì „ ê²€ìƒ‰ì •ë³´ ì‚­ì œ
                // ë°˜ê²½ ì‚­ì œ
                if (!!circle) {
                    circle.setMap(null);
                }

                // ë§ˆì»¤ ì‚­ì œ
                for (var i = 0; i < markers.length; i++) {
                    if (markers[i].setMap()) {
                        markers[i].setMap(null);
                    }
                    recognizer.remove(markers[i]);
                }
                naver.maps.Event.clearInstanceListeners(recognizer); // recognizerì— ë“±ë¡ëœ ì´ë²¤íŠ¸ ëª¨ë‘ ì‚­ì œ

                // ì‹ ê·œ ê²€ìƒ‰ì •ë³´ ì¶”ê°€
                // ë°˜ê²½ ì¶”ê°€
                circle = new naver.maps.Circle({
                    map: map,
                    center: map.getCenter(),
                    radius: 500,
                    fillColor: '#d1e7dd',
                    fillOpacity: 0.3,
                    strokeColor: '#198754'
                });

                listHtml = ``; // ë¦¬ìŠ¤íŠ¸ HTML íƒœê·¸

                // ì‹ ê·œ ë§ˆì»¤ì™€ ë¦¬ìŠ¤íŠ¸ ì¶”ê°€
                for (var key in data) {

                    // var position = new naver.maps.LatLng(
                    //     data[key].lat,
                    //     data[key].lng
                    // );

                    // var marker = new naver.maps.Marker({
                    //     map: map,
                    //     position: position,
                    //     // title: key,
                    //     zIndex: 100
                    // });

                    // if (!marker.setMap()) {
                    //     marker.setMap(map);
                    // }

                    let summaryHTML = ``;
                    if(!!data[key].storeSize && !!data[key].consentScoreRep && !!data[key].wifiScoreRep && !!data[key].comfortScoreRep){
                        let storeSize = `ë§¤ì¥ `;
                        if(data[key].storeSize == 'TAKEOUT'){
                            storeSize += `<span class="text-danger">í¬ì¥</span>`; //
                        }else if(data[key].storeSize == 'SMALL'){
                            storeSize += `<span class="text-warning">ì†Œí˜•</span>`; //
                        }else if(data[key].storeSize == 'MEDIUM'){
                            storeSize += `<span class="text-success">ì¤‘í˜•</span>`; //text-primary
                        }
                        else if(data[key].storeSize == 'LARGE'){
                            storeSize += `<span class="text-primary">ëŒ€í˜•</span>`; //text-success
                        }

                        let consentScoreRep = `ì½˜ì„¼íŠ¸ `;
                        if(data[key].consentScoreRep == '1'){
                            consentScoreRep += `<span class="text-danger">ì—†ìŒ</span>`; //
                        }else if(data[key].consentScoreRep == '2'){
                            consentScoreRep += `<span class="text-warning">ì ìŒ</span>`; //
                        }else if(data[key].consentScoreRep == '3'){
                            consentScoreRep += `<span class="text-success">ì¶©ë¶„</span>`; //text-primary
                        }
                        else if(data[key].consentScoreRep == '4'){
                            consentScoreRep += `<span class="text-primary">ë§ìŒ</span>`; //text-success
                        }

                        let wifiScoreRep = `WiFi `;
                        if(data[key].wifiScoreRep == '1'){
                            wifiScoreRep += `<span class="text-danger">ì—†ìŒ</span>`; //
                        }else if(data[key].wifiScoreRep == '2'){
                            wifiScoreRep += `<span class="text-warning">ëŠë¦¼</span>`; //
                        }else if(data[key].wifiScoreRep == '3'){
                            wifiScoreRep += `<span class="text-success">ì›í™œ</span>`; //text-primary
                        }
                        else if(data[key].wifiScoreRep == '4'){
                            wifiScoreRep += `<span class="text-primary">ì¾Œì </span>`; //text-success
                        }

                        let comfortScoreRep = `ì¢Œì„ `;
                        if(data[key].comfortScoreRep == '1'){
                            comfortScoreRep += `<span class="text-danger">ì•„í””</span>`; //
                        }else if(data[key].comfortScoreRep == '2'){
                            comfortScoreRep += `<span class="text-warning">ë¶ˆí¸</span>`; //
                        }else if(data[key].comfortScoreRep == '3'){
                            comfortScoreRep += `<span class="text-success">í¸ì•ˆ</span>`; //
                        }
                        else if(data[key].comfortScoreRep == '4'){
                            comfortScoreRep += `<span class="text-primary">ì•ˆë½</span>`; //
                        }

                        summaryHTML = storeSize+'/'+consentScoreRep+'/'+wifiScoreRep+'/'+comfortScoreRep;
                    }



                    let reviewCntHtml = ``;
                    if(data[key].reviewCnt > 0){
                        reviewCntHtml = ` <span class="badge bg-success rounded-pill" style="margin-block-end: auto;vertical-align: text-bottom;">${data[key].reviewCnt}</span>`; //
                    }else{
                        reviewCntHtml = `<small></small>`; //ë¦¬ë·°ì—†ìŒ
                    }

                    var markerContent = [
                            '<div style="position:absolute;">',
                            // '<div class="infowindow" style="display:none;position:absolute;width:220px;height:20px;top:-46px;left:-100px;background-color:white;z-index:1;border:1px solid black;margin:0;padding:0;">',
                            // '<a href="#" class="spmc btn_clear">í•€ ì‚­ì œ</a>',
                            // '<div>HTML ë§ˆì»¤ ì½˜í…ì¸ ì…ë‹ˆë‹¤.</div>',
                            // '<div style="margin: 0px; padding: 0px; width: 0px; height: 0px; position: absolute; border-width: 24px 10px 0px; border-style: solid; border-color: rgb(51, 51, 51) transparent; border-image: initial; pointer-events: none; box-sizing: content-box !important; transform-origin: right bottom 0px; transform: skewX(0deg); bottom: -25px; left: 100px;"></div>',
                            // '<div style="margin: 0px; padding: 0px; width: 0px; height: 0px; position: absolute; border-width: 24px 10px 0px; border-style: solid; border-color: rgb(255, 255, 255) transparent; border-image: initial; pointer-events: none; box-sizing: content-box !important; transform-origin: right bottom 0px; transform: skewX(0deg); bottom: -22px; left: 100px;"></div>',
                            // '</div>',
                            '<div class="pin_s" style="cursor: pointer; width: 22px; height: 30px;">',
                            // '<img src="https://ssl.pstatic.net/static/maps/img/icons/pin_s_3.png" alt="" style="margin: 0px; padding: 0px; border: 0px solid transparent; display: block; max-width: none; max-height: none; -webkit-user-select: none; position: absolute; width: 22px; height: 30px; left: 0px; top: 0px;">',
                            // '<div class="pins_s_tooltip" style="display:none;width:150px;height:20px;position:absolute;top:5px;left:25px;font-size: 12px;">' + data[key].cafeNm + '</div>',
                            '<div class="pins_s_tooltip text-success" style="border-radius: 25px;width:max-content;height:max-content;position:absolute;margin: 0px; padding: 0px 7px;border: 1px solid green;font-size: 16px;font-weight: bold;background-color: white;">' + //
                            data[key].cafeNm + reviewCntHtml +
                            // summaryHTML +
                            '</div>',
                            '</div>',
                            '</div>'
                        ].join(''),
                        htmlMarker = new naver.maps.Marker({
                            position: new naver.maps.LatLng(data[key].lat, data[key].lng),
                            title: data[key].cafeNm,
                            map: map,
                            icon: {
                                content: markerContent,
                                highlight: false,
                                size: new naver.maps.Size(22, 30),
                                anchor: new naver.maps.Point(11, 30)
                            }
                        }),
                        elHtmlMarker = htmlMarker.getElement();

                    // $(elHtmlMarker).on('mouseenter', 'img', function (e) {
                    //     console.log(e);
                    //     $(elHtmlMarker).find('.pins_s_tooltip').show();
                    // });

                    // $(elHtmlMarker).on('mouseout', 'img', function (e) {
                    //     $(elHtmlMarker).find('.pins_s_tooltip').hide();
                    // });




                    // var infoWindow = new naver.maps.InfoWindow({
                    //     content: '<div style="width:150px;text-align:center;padding:10px;">The Letter is <b>"'+ key.substr(0, 1) +'"</b>.</div>'
                    // });

                    // var contentString = [
                    //     '<div class="iw_inner">',
                    //     '   <h3>'+data[key].cafeNm+'</h3>',
                    //     '</div>'
                    // ].join('');

                    // var infowindow = new naver.maps.InfoWindow({
                    //     content: contentString
                    // });


                    htmlMarker.addListener('mouseover', function(e) {
                        highlightMarker(e.overlay);
                    });
                    htmlMarker.addListener('mouseout', function(e) {
                        unhighlightMarker(e.overlay);
                    });

                    htmlMarker.addListener('click', getClickHandler(data[key].cafeId, data[key].lat, data[key].lng));

                    // naver.maps.Event.addListener(htmlMarker, "click", getClickHandler(data[key].cafeId, data[key].lat, data[key].lng));

                    // infowindow.open(map, marker);



                    listHtml += `<a href="javascript:cafeInfo(${data[key].cafeId});" id=${data[key].cafeId} class="list-group-item list-group-item-action" style="min-height: 70px;">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h5 class="mb-1 fw-bold">${data[key].cafeNm}</h5>`
                                        + reviewCntHtml +
                                    `</div>
                                    <p class="mb-1 fw-bold" style="font-size: 13px">`+summaryHTML+`</p>
                                 </a>`;

                    markers.push(htmlMarker);
                    // infoWindows.push(infowindow);
                    recognizer.add(htmlMarker);
                }

                cafeList.innerHTML = listHtml;

                var overlapCoverMarker = null;
                naver.maps.Event.addListener(recognizer, 'overlap', function(list) {
                    console.log('overlap');

                    if (overlapCoverMarker) {
                        unhighlightMarker(overlapCoverMarker);
                    }

                    overlapCoverMarker = list[0].marker;

                    naver.maps.Event.once(overlapCoverMarker, 'mouseout', function() {
                        console.log('mouseout');
                        highlightMarker(overlapCoverMarker);
                        // unhighlightMarker(overlapCoverMarker);
                    });
                });

                naver.maps.Event.addListener(recognizer, 'clickItem', function(e) {
                    console.log('clickItem');
                    recognizer.hide();

                    if (overlapCoverMarker) {
                        unhighlightMarker(overlapCoverMarker);

                        overlapCoverMarker = null;
                    }
                });


            });
        }

        // ì§€ë„ dragend ì´ë²¤íŠ¸ ë“±ë¡
        naver.maps.Event.addListener(map, 'dragend', function (e) {
            // console.log(e.coord._lng + ' ' + e.coord._lat);

            dragend();
        });

        // ì¹´í˜ì •ë³´ ì¡°íšŒ (ì¹´í˜ë¦¬ìŠ¤íŠ¸ì—ì„œ í´ë¦­ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜)
        function cafeInfo(cafeId) {

            closeReview(); // ê¸°ì¡´ ë¦¬ë·°ì“°ê¸° í™”ë©´ close

            // ì´ì „ì— ì„ íƒí•œ ì¹´í˜ê°€ ìˆë‹¤ë©´ non active ìƒíƒœë¡œ ë³€ê²½ (ë‹«ê¸°ë²„íŠ¼ ì•ˆ ëˆ„ë¥´ê³  ë¦¬ìŠ¤íŠ¸ì—ì„œ ë°”ë¡œ ë‹¤ë¥¸ ì¹´í˜ ëˆŒëŸ¬ì„œ ì´ë™í•  ë•Œ)
            let beforeP = document.getElementById("cafeInfoId");
            if (!!beforeP) {
                var beforeCafeId = beforeP.innerText;
                let beforeA = document.getElementById(beforeCafeId);
                if (!!beforeA) {
                    beforeA.className = "list-group-item list-group-item-action";
                }
            }

            // ë¦¬ìŠ¤íŠ¸ì—ì„œ ì„ íƒí•œ ì¹´í˜ active ìƒíƒœë¡œ ë³€ê²½
            let a = document.getElementById(cafeId);
            a.className = "list-group-item list-group-item-action active";

            openCafeInfo(); // ì¹´í˜ì •ë³´ í™”ë©´ open

            // ì¹´í˜ ì •ë³´ fetch
            postData("http://localhost/cafe/" + cafeId, {}).then((data) => {
                console.log(data); // JSON data parsed by `data.json()` call

                // ë°›ì•„ì˜¨ ë‚´ìš© ì¶”ê°€
                let cafeInfoDiv = document.getElementById("cafeInfo"); // ì¹´í˜ì •ë³´
                let reviewHeader = document.getElementById("reviewHeader"); // ë¦¬ë·°í—¤ë” (ë¦¬ë·°ê±´ìˆ˜ í‘œê¸°)
                let reviewList = document.getElementById("reviewList"); // ë¦¬ë·°ëª©ë¡

                // ì¹´í˜ì •ë³´ ë²„íŠ¼ìœ¼ë¡œ ë³´ì—¬ì£¼ê¸°
                let buttonHtml =  buttonMaker(data.cafeDto.storeSize, data.cafeDto.floor, data.cafeDto.consentScoreRep, data.cafeDto.wifiScoreRep, data.cafeDto.comfortScoreRep);

                // ì¹´í˜ ì •ë³´ ì„¸íŒ…
                let html = `<div class="card-body text-success">
                                <p hidden="hidden" id="cafeInfoId">${data.cafeDto.cafeId}</p>
                                <h5 class="card-title">${data.cafeDto.cafeNm}</h5>
                                <p class="card-text">
                                    ì§€ì ëª…: ${data.cafeDto.brchNm}<br>
                                    ê±´ë¬¼ëª…: ${data.cafeDto.bldNm}<br>
                                    ì—…ì¢…: ${data.cafeDto.indsSclsNm}<br>
                                    ì£¼ì†Œ: ${data.cafeDto.rdnmAdr}<br>
                                </p>`
                                + buttonHtml +
                            `</div>`;
                            //<div class="card-footer bg-transparent border-success">ì •ë³´ ìˆ˜ì •ìš”ì²­</div>`;
                cafeInfoDiv.innerHTML = html;

                // ë¦¬ë·° ê±´ìˆ˜ ì„¸íŒ…
                html = `<span>ë¦¬ë·° ${data.reviewDTOList.length}ê±´</span><button type="button" class="btn btn-outline-success" onclick="loginCheck('review')">ë¦¬ë·° ì“°ê¸°</button>`;
                //onclick="openReview()
                //loginCheck()
                //data-bs-toggle="modal" data-bs-target="#exampleModal"
                reviewHeader.innerHTML = html;


                // ë¦¬ë·° ì •ë³´ ì„¸íŒ…
                html = ``;
                let modButtonHTML = ``;
                for (var i = 0; i < data.reviewDTOList.length; i++) {
                    //console.log([[${userId}]]+' '+data.reviewDTOList[i].userId);
                    if([[${userId}]] == data.reviewDTOList[i].userId){
                        modButtonHTML = `<button type="button" class="btn btn-outline-success mt-2 mx-1 float-end" onclick="remove(${data.reviewDTOList[i].reviewId}, ${data.cafeDto.cafeId})">ì‚­ì œ</button>`;
                                         //<button type="button" class="btn btn-outline-success mt-2 mx-1 float-end" onclick="modify(${data.reviewDTOList[i].reviewId})">ìˆ˜ì •</button>`;
                    }

                    buttonHtml =  buttonMaker(data.reviewDTOList[i].storeSize, data.reviewDTOList[i].floor, data.reviewDTOList[i].consentScore, data.reviewDTOList[i].wifiScore, data.reviewDTOList[i].comfortScore);
                    html += `<li class="list-group-item">
                                <div class="d-flex w-100 justify-content-between mb-1">
                                    <small class="mb-1 fw-bold">${data.reviewDTOList[i].userEmailId}</small>
                                    <small>${data.reviewDTOList[i].regTime}</small>
                                </div>
                                <p class="mb-1">${data.reviewDTOList[i].content}</p>`
                              + buttonHtml + modButtonHTML +
                             `</li>`;
                }
                reviewList.innerHTML = html;

            });

        }

        // ì¹´í˜ì •ë³´ & ë¦¬ë·°ì—ì„œ ì‚¬ìš©ìê°€ ì„ íƒí•œ ë²„íŠ¼ HTML ë§Œë“¤ì–´ ì£¼ëŠ” í•¨ìˆ˜
        function buttonMaker(storeSize,floor,consent,wifi,confort){

            let buttonTemplate =  `<button type="button" class="btn btn-outline-success p-1 mt-1 me-1" style="pointer-events: none;">`;
            let buttonHtml = ``;

            // ë§¤ì¥í¬ê¸°
            if(!!storeSize) {
                buttonHtml += buttonTemplate;
                if (storeSize == 'TAKEOUT') {
                    buttonHtml += `í¬ì¥ ì „ìš©ğŸ`;
                } else if (storeSize == 'SMALL') {
                    buttonHtml += `ì†Œí˜• ë§¤ì¥ğŸ `;
                } else if (storeSize == 'MEDIUM') {
                    buttonHtml += `ì¤‘í˜• ë§¤ì¥ğŸ˜`;
                } else if (storeSize == 'LARGE') {
                    buttonHtml += `ëŒ€í˜• ë§¤ì¥ğŸ°`;
                }
                buttonHtml += `</button>`;
            }

            // ì¸µìˆ˜
            if(!!floor) {
                buttonHtml += buttonTemplate;
                if (floor == 'FIRST') {
                    buttonHtml += `1ì¸µğŸš¶â€â™‚ï¸`;
                } else if (floor == 'SECOND') {
                    buttonHtml += `2ì¸µğŸª‚`;
                } else if (floor == 'THIRD') {
                    buttonHtml += `3ì¸µâœˆ`;
                } else if (floor == 'MORE') {
                    buttonHtml += `4ì¸µ ì´ìƒğŸ›°`;
                }
                buttonHtml += `</button>`;
            }

            // ì½˜ì„¼íŠ¸
            if(!!consent) {
                buttonHtml += buttonTemplate;
                if (consent == '1') {
                    buttonHtml += `ì½˜ì„¼íŠ¸ ì—†ìŒğŸš«`;
                } else if (consent == '2') {
                    buttonHtml += `ì½˜ì„¼íŠ¸ ì ìŒâ˜`;
                } else if (consent == '3') {
                    buttonHtml += `ì½˜ì„¼íŠ¸ ë§ìŒğŸŒ©`;
                } else if (consent == '4') {
                    buttonHtml += `ì½˜ì„¼íŠ¸ ì•„ì£¼ ë§ìŒ!âš¡`;
                }
                buttonHtml += `</button>`;
            }

            // ì™€ì´íŒŒì´
            if(!!wifi) {
                buttonHtml += buttonTemplate;
                if (wifi == '1') {
                    buttonHtml += `ì™€ì´íŒŒì´ ì—†ìŒğŸš«`;
                } else if (wifi == '2') {
                    buttonHtml += `ì™€ì´íŒŒì´ ëŠë¦¼ğŸ›´`;
                } else if (wifi == '3') {
                    buttonHtml += `ì™€ì´íŒŒì´ ì›í™œğŸš—`;
                } else if (wifi == '4') {
                    buttonHtml += `ì™€ì´íŒŒì´ ì¾Œì !ğŸš€`;
                }
                buttonHtml += `</button>`;
            }

            // í¸ì•ˆí•¨
            if(!!confort) {
                buttonHtml += buttonTemplate;
                if (confort == '1') {
                    buttonHtml += `ì¢Œì„ì´ ë¶ˆí¸ğŸ§—`;
                } else if (confort == '2') {
                    buttonHtml += `í¸í•˜ì§„ ì•Šì•„ìš”ğŸ¤¸`;
                } else if (confort == '3') {
                    buttonHtml += `ì¢Œì„ í¸ì•ˆğŸ§˜`;
                } else if (confort == '4') {
                    buttonHtml += `ì¢Œì„ ì•ˆë½!ğŸ›Œ`;
                }
                buttonHtml += `</button>`;
            }

            return buttonHtml;
        }

        // ì¹´í˜ ì •ë³´ open
        function openCafeInfo() {
            document.getElementById("overlay1").style.display = "block";
            document.getElementById("overlay2").style.display = "block";
            // document.getElementsByClassName("overlay").style.display = "block";
        }

        // ë¦¬ë·° ì“°ê¸° open
        function openReview() {
            document.getElementById("overlay3").style.display = "block";
            // document.getElementById("overlay2").style.display = "block";
            // document.getElementsByClassName("overlay").style.display = "block";
        }

        // ì¹´í˜ ì •ë³´ & ë¦¬ë·° ì“°ê¸° close
        function closeAll() {
            document.getElementById("overlay1").style.display = "none";
            document.getElementById("overlay2").style.display = "none";
            document.getElementById("overlay3").style.display = "none";

            // ì„ íƒí•œ í•­ëª© non active ìƒíƒœë¡œ ë³€ê²½
            let p = document.getElementById("cafeInfoId");
            var cafeId = p.innerText;

            let a = document.getElementById(cafeId);
            if (!!a) {
                a.className = "list-group-item list-group-item-action";
            }
        }

        // ë¦¬ë·° ì“°ê¸° close
        function closeReview() {
            document.getElementById("overlay3").style.display = "none";
        }

        // ìœ„ì¹˜ ì˜µì…˜
        const options = {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0,
        };

        // í˜„ì¬ìœ„ì¹˜ ì°¾ê¸°
        navigator.geolocation.getCurrentPosition(success, error, options);

        // ìœ„ì¹˜ ì°¾ê¸° ì„±ê³µì‹œ
        function success(pos) {
            const crd = pos.coords;

            console.log("Your current position is:");
            console.log(`Latitude : ${crd.latitude}`);
            console.log(`Longitude: ${crd.longitude}`);
            console.log(`More or less ${crd.accuracy} meters.`);

            map.setCenter(new naver.maps.LatLng(crd.latitude, crd.longitude)); // ì¤‘ì‹¬ ì¢Œí‘œ ì´ë™
            // map.setCenter(new naver.maps.LatLng(37.5594976, 127.1488309)); // ì¤‘ì‹¬ ì¢Œí‘œ ì´ë™ (ê³ ë•)

            // í˜„ì¬ ìœ„ì¹˜ ì§€ë„ì— í‘œì‹œ (ì´ˆë¡ìƒ‰ ì ìœ¼ë¡œ)
            // var marker = new naver.maps.Marker({
            //     position: new naver.maps.LatLng(crd.latitude, crd.longitude),
            //     map: map
            // })

            dragend();
        }

        function error(err) {
            console.warn(`ERROR(${err.code}): ${err.message}`);
        }

        // nullë¨¼ì € ì²´í¬í•œ í›„ì— valueë¡œ ê°’ë°›ì•„ì„œ ë¦¬í„´í•˜ëŠ” í•¨ìˆ˜
        function nullCheckBeforeValue(checked){
            if(!!checked){
                return checked.value;
            }else{
                return null;
            }
        }

        function register() {
            var storeSize = nullCheckBeforeValue(document.querySelector('input[name="options-size"]:checked'));
            var floor = nullCheckBeforeValue(document.querySelector('input[name="options-floor"]:checked'));
            var consentScore = nullCheckBeforeValue(document.querySelector('input[name="options-consent"]:checked'));
            var wifiScore = nullCheckBeforeValue(document.querySelector('input[name="options-wifi"]:checked'));
            var comfortScore = nullCheckBeforeValue(document.querySelector('input[name="options-comfort"]:checked'));
            var content = document.getElementById("floatingTextarea").value;
            var cafeId = document.getElementById("cafeInfoId").innerText;

            // í•„ìˆ˜í•­ëª© ì „ë¶€ ì…ë ¥í–ˆëŠ”ì§€ í™•ì¸ (ë¦¬ë·°ë‚´ìš©ì€ í•„ìˆ˜ ì•„ë‹˜)
            if(!storeSize ||
                !floor ||
                !consentScore ||
                !wifiScore ||
                !comfortScore ||
                !cafeId
            ){
                alert('ì„ íƒí•˜ì§€ ì•Šì€ í•­ëª©ì´ ìˆìŠµë‹ˆë‹¤!');
                return;
            }

            var json = {
                'userId': [[${userId}]],
                'cafeId': cafeId,
                'storeSize': storeSize,
                'floor': floor,
                'consentScore': consentScore, 'wifiScore': wifiScore, 'comfortScore': comfortScore,
                'content': content
            };

            console.log(json);

            postData("http://localhost/review/register", json).then((data) => {
                console.log(data); // JSON data parsed by `data.json()` call
                cafeInfo(cafeId);  // ë¦¬ë·° ë“±ë¡í›„ì— ì¹´í˜ì •ë³´ reload
            });
        }

        function remove(reviewId, cafeId){

            postData("http://localhost/review/remove/"+reviewId, {}).then((data) => {
                console.log(data); // JSON data parsed by `data.json()` call
                cafeInfo(cafeId);  // ë¦¬ë·° ë“±ë¡í›„ì— ì¹´í˜ì •ë³´ reload
            });
        }

        function loginCheck(action) {
            let user = document.getElementById("user");

            // ë¡œê·¸ì¸ í–ˆìœ¼ë©´
            if(!!user){
                // ë¦¬ë·° ì‘ì„±ìœ¼ë¡œ ì´ë™
                if(action == 'review'){
                    openReview();
                }else if(action == 'mypage'){

                }
            }else{
                // ë¡œê·¸ì¸ ìš”ì²­ ëª¨ë‹¬ show
                var myModal = new bootstrap.Modal(document.getElementById("exampleModal"), {});
                myModal.show();
            }
        }

    </script>


</div>

</html>